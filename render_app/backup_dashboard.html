<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Logger - Backup Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }

        .status-card.healthy {
            border-left-color: #2ecc71;
        }

        .status-card.warning {
            border-left-color: #f39c12;
        }

        .status-card.error {
            border-left-color: #e74c3c;
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .status-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .status-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.green {
            background: #2ecc71;
        }

        .status-indicator.yellow {
            background: #f39c12;
        }

        .status-indicator.red {
            background: #e74c3c;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .action-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .action-btn.success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .backup-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .backup-list h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .backup-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .backup-info {
            flex: 1;
        }

        .backup-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .backup-meta {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .backup-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-restore {
            background: #2ecc71;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>🔒 BTC Logger Backup Dashboard</h1>
            <p>Monitor and manage your data backups</p>
        </div>

        <div id="alerts"></div>

        <div class="status-grid">
            <div class="status-card" id="system-status">
                <h3>System Status</h3>
                <div class="status-item">
                    <span class="status-label">Overall Health</span>
                    <span class="status-value" id="overall-health">
                        <span class="loading"></span> Checking...
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Log Time</span>
                    <span class="status-value" id="last-log-time">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Data Files</span>
                    <span class="status-value" id="data-files-count">-</span>
                </div>
            </div>

            <div class="status-card" id="backup-status">
                <h3>Backup Status</h3>
                <div class="status-item">
                    <span class="status-label">Backup Enabled</span>
                    <span class="status-value" id="backup-enabled">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Backup</span>
                    <span class="status-value" id="last-backup-time">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Available Providers</span>
                    <span class="status-value" id="available-providers">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Backup Interval</span>
                    <span class="status-value" id="backup-interval">-</span>
                </div>
            </div>

            <div class="status-card" id="data-integrity">
                <h3>Data Integrity</h3>
                <div class="status-item">
                    <span class="status-label">Status</span>
                    <span class="status-value" id="integrity-status">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Needs Restore</span>
                    <span class="status-value" id="needs-restore">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Recent Files</span>
                    <span class="status-value" id="recent-files">-</span>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="action-btn success" onclick="triggerBackup()">
                🔄 Trigger Backup
            </button>
            <button class="action-btn" onclick="restoreFromBackup()">
                📥 Restore Data
            </button>
            <button class="action-btn secondary" onclick="refreshStatus()">
                🔃 Refresh Status
            </button>
            <button class="action-btn danger" onclick="cleanupBackups()">
                🗑️ Cleanup Old Backups
            </button>
        </div>

        <div class="backup-list">
            <h3>Recent Backups</h3>
            <div id="backup-files">
                <div class="loading"></div> Loading backup files...
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStatus = {};
        let backupFiles = {};

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            return new Date(timestamp).toLocaleString();
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusIndicator(status) {
            const indicators = {
                healthy: '<span class="status-indicator green"></span>Healthy',
                degraded: '<span class="status-indicator yellow"></span>Degraded',
                error: '<span class="status-indicator red"></span>Error',
                true: '<span class="status-indicator green"></span>Yes',
                false: '<span class="status-indicator red"></span>No'
            };
            return indicators[status] || status;
        }

        // API functions
        async function fetchStatus() {
            try {
                const healthResponse = await fetch('/health');
                const health = await healthResponse.json();
                
                let backup = null;
                let integrity = null;
                
                // Try enhanced backup endpoints first
                if (health.enhanced_backup && health.enhanced_backup !== "Not Available") {
                    try {
                        const backupResponse = await fetch('/backup/enhanced/status');
                        backup = await backupResponse.json();
                        
                        // Enhanced backup includes integrity check
                        integrity = backup.data_integrity || { status: 'unknown', needs_restore: false };
                    } catch (e) {
                        console.warn('Enhanced backup endpoints not available, using legacy');
                    }
                }
                
                // Fallback to legacy endpoints
                if (!backup) {
                    try {
                        const backupResponse = await fetch('/backup/status');
                        backup = await backupResponse.json();
                        integrity = { status: 'unknown', needs_restore: false, message: 'Using legacy backup' };
                    } catch (e) {
                        console.warn('Legacy backup endpoints not available either');
                        backup = { error: 'No backup endpoints available' };
                        integrity = { status: 'unknown', needs_restore: false };
                    }
                }

                currentStatus = { health, backup, integrity };
                updateStatusDisplay();
            } catch (error) {
                console.error('Error fetching status:', error);
                showAlert('Failed to fetch system status', 'error');
            }
        }

        async function fetchBackupFiles() {
            try {
                let response;
                
                // Try enhanced backup list first
                try {
                    response = await fetch('/backup/enhanced/list');
                    const data = await response.json();
                    if (data.enhanced_backup) {
                        backupFiles = data;
                        updateBackupList();
                        return;
                    }
                } catch (e) {
                    console.warn('Enhanced backup list not available, using legacy');
                }
                
                // Fallback to legacy backup list
                response = await fetch('/backup/list');
                const data = await response.json();
                
                // Convert legacy format to enhanced format
                backupFiles = {
                    providers: ['gcs'],
                    backups: { gcs: data.backups || [] },
                    total_files: data.count || 0
                };
                
                updateBackupList();
            } catch (error) {
                console.error('Error fetching backup files:', error);
                showAlert('Failed to fetch backup files', 'error');
            }
        }

        async function triggerBackup() {
            try {
                showAlert('Triggering backup...', 'success');
                
                let response;
                // Try enhanced backup first
                try {
                    response = await fetch('/backup/enhanced/trigger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (e) {
                    // Fallback to legacy backup
                    response = await fetch('/backup/trigger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Backup completed successfully!', 'success');
                    await fetchStatus();
                    await fetchBackupFiles();
                } else {
                    showAlert(`Backup failed: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error triggering backup:', error);
                showAlert('Failed to trigger backup', 'error');
            }
        }

        async function restoreFromBackup() {
            if (!confirm('Are you sure you want to restore from backup? This will replace current data.')) {
                return;
            }

            try {
                showAlert('Restoring from backup...', 'success');
                
                let response;
                // Try enhanced restore first
                try {
                    response = await fetch('/backup/enhanced/restore', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (e) {
                    showAlert('Enhanced restore not available. Please use legacy backup or configure enhanced backup system.', 'error');
                    return;
                }
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Data restored successfully!', 'success');
                    await fetchStatus();
                } else {
                    showAlert(`Restore failed: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
                showAlert('Failed to restore backup', 'error');
            }
        }

        async function cleanupBackups() {
            const keepCount = prompt('How many recent backups to keep?', '10');
            if (!keepCount) return;

            try {
                showAlert('Cleaning up old backups...', 'success');
                const response = await fetch('/backup/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keep_count: parseInt(keepCount) })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Cleanup completed successfully!', 'success');
                    await fetchBackupFiles();
                } else {
                    showAlert('Cleanup failed', 'error');
                }
            } catch (error) {
                console.error('Error cleaning up backups:', error);
                showAlert('Failed to cleanup backups', 'error');
            }
        }

        function refreshStatus() {
            fetchStatus();
            fetchBackupFiles();
            showAlert('Status refreshed', 'success');
        }

        // Update display functions
        function updateStatusDisplay() {
            const { health, backup, integrity } = currentStatus;

            // System status
            document.getElementById('overall-health').innerHTML = getStatusIndicator(health?.status || 'unknown');
            document.getElementById('last-log-time').textContent = formatTimestamp(health?.last_log_time);
            
            // Update card color based on health
            const systemCard = document.getElementById('system-status');
            systemCard.className = `status-card ${health?.status || 'error'}`;

            // Backup status
            if (backup?.backup_system) {
                const bs = backup.backup_system;
                document.getElementById('backup-enabled').innerHTML = getStatusIndicator(bs.backup_enabled);
                document.getElementById('last-backup-time').textContent = formatTimestamp(bs.last_backup_time);
                document.getElementById('available-providers').textContent = bs.available_providers?.join(', ') || 'None';
                document.getElementById('backup-interval').textContent = `${bs.backup_interval_minutes} minutes`;
                
                // Update card color
                const backupCard = document.getElementById('backup-status');
                backupCard.className = `status-card ${bs.backup_enabled ? 'healthy' : 'warning'}`;
            }

            // Data integrity
            if (integrity) {
                document.getElementById('integrity-status').innerHTML = getStatusIndicator(integrity.status);
                document.getElementById('needs-restore').innerHTML = getStatusIndicator(!integrity.needs_restore);
                document.getElementById('recent-files').textContent = integrity.recent_files?.length || integrity.total_files || 0;
                
                // Update card color
                const integrityCard = document.getElementById('data-integrity');
                integrityCard.className = `status-card ${integrity.needs_restore ? 'error' : 'healthy'}`;
            }
        }

        function updateBackupList() {
            const container = document.getElementById('backup-files');
            
            if (!backupFiles.backups || Object.keys(backupFiles.backups).length === 0) {
                container.innerHTML = '<p>No backup files found</p>';
                return;
            }

            let html = '';
            for (const [provider, files] of Object.entries(backupFiles.backups)) {
                if (files.length === 0) continue;
                
                html += `<h4 style="margin: 20px 0 10px 0; color: #2c3e50;">${provider.toUpperCase()} Provider</h4>`;
                
                // Show only recent 5 files per provider
                const recentFiles = files.slice(0, 5);
                for (const file of recentFiles) {
                    html += `
                        <div class="backup-item">
                            <div class="backup-info">
                                <div class="backup-name">${file.name}</div>
                                <div class="backup-meta">
                                    ${formatBytes(file.size)} • ${formatTimestamp(file.created)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (files.length > 5) {
                    html += `<p style="color: #7f8c8d; font-style: italic; margin: 10px 0;">... and ${files.length - 5} more files</p>`;
                }
            }
            
            container.innerHTML = html;
        }

        // Initialize dashboard
        window.addEventListener('load', () => {
            fetchStatus();
            fetchBackupFiles();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                fetchStatus();
            }, 30000);
            
            // Refresh backup files every 5 minutes
            setInterval(() => {
                fetchBackupFiles();
            }, 300000);
        });
    </script>
</body>
</html>